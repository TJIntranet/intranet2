#!/usr/bin/php5
<?php

define('CONFIG_FILENAME', 'config.ini');

require_once('functions.inc.php5');

$map = array();

function process_dir($dir) {
	global $map;

	if ($handle = opendir($dir)) {
		while (FALSE !== ($file = readdir($handle))) {
			if ($file == '.' || $file == '..') {
				continue;
			}

			if (is_dir($dir . $file)) {
				if (!process_dir("$dir$file/")) {
					return FALSE;
				}
			} else {
				$arr = split('\.', $file);
				$map[strtolower($arr[0])] = "$dir$file";
			}
		}
	} else {
		return FALSE;
	}
	return TRUE;
}

$module_path = i2config_get('module_path', NULL, 'core');
$cache_dir = i2config_get('cache_dir', NULL, 'core');
$map_file = $cache_dir . 'module.map';

if (!process_dir($module_path)) {
	error("Error! Could not process modules directory $module_path");
}

if (!is_dir($cache_dir)) {
	if (!mkdir($cache_dir, 0700, TRUE)) {
		error("Error! Could not create cache dir $cache_dir");
	}
}

if (!file_put_contents($map_file, serialize($map))) {
	error("Error! Could not write contents to $map_file");
}

exit(0);

?>
